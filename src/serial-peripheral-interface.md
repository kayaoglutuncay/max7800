The Serial Peripheral Interface (SPI) is a highly configurable, flexible, and efficient synchronous interface between multiple SPI devices on a single bus. The SPI bus uses a single clock signal, and single, dual, or quad data lines, and one or more slave select lines for communication with external SPI devices.

The provided SPI ports support full-duplex, bi-direction I/O, and each SPI includes a bit rate generator (BRG) for generating the clock signal when operating in master mode. Each SPI port operates independently and requires minimal processor overhead. All instances of the SPI peripheral support both master and slave modes and support single master and multi-master networks.

Features include:

- Dedicated Bit Rate Generator for precision serial clock generation in Master Mode

    - Up to $\frac{f_{\text{PCLK}}}{2}$ for instances on the APB bus
    - Up to $\frac{f_{\text{HCLK}}}{2}$ for instances on the AHB bus
    - Programmable SCK duty cycle timing

- Full-duplex, synchronous communication of 2 to 16-bit characters

    - 1-bit and 9-bit characters are not supported
    - 2-bit and 10-bit characters do not support maximum clock speed. SPIn_CLKCTRL.clkdiv must be > 0

- 3-wire and 4-wire SPI operation for single-bit communication
- Single, dual, or quad I/O operation
- Byte-wide transmit and receive FIFOs with 32-byte depth

    - For character sizes greater than 8, each character uses 2 entries per character resulting in 16 entries for the transmit and receive FIFO

- Transmit and receive DMA support
- SPI modes 0, 1, 2, 3
- Configurable slave select lines

    - Programmable slave select level

- Programmable slave select timing with respect to SCK starting edge and ending edge
- Multi-master mode fault detection

Figure 13-1 shows a high-level block diagram of the SPI peripheral. See Table 13-1 for the peripheral-specific peripheral bus assignment and bit rate generator clock source.

*Figure 13-1: SPI Block Diagram*

* The number of slave select signals can vary for each instance of the peripheral.
** The bus interface (APB or AHB) can vary for each instance of the peripheral.

## Instances
There are two instances of the SPI peripheral, as shown in Table 13-1. Table 13-2 lists the locations of the SPI signals for each of the SPI instances.

*Table 13-1: MAX78000 SPI Instances*

*Note: Refer to the MAX78000 data sheet for each peripheral's definitive list of alternate function assignments.*

*Table 13-2: MAX78000 SPI Peripheral Pins*

## Format
### Four-Wire SPI
SPI devices operate as either a master or a slave device. In four-wire SPI, four signals are required for communication, as shown in Table 13-3.

*Table 13-3: Four-Wire Format Signals*

In a typical SPI network, the master device selects the slave device using the slave select output. The master starts the communication by selecting the slave device by asserting the slave select output. The master then starts the SPI clock through the SCK output pin. When a slave device's slave select pin is deasserted, the device must put the SPI pins in tri-state mode.

### Three-Wire SPI
The signals in three-wire SPI operation are shown in Table 13-4. The MOSI signal is used as a bi-directional, half-duplex I/O referred to as slave input slave output (SISO). Three-wire SPI also uses a serial clock signal generated by the master and a slave select pin controlled by the master.

*Table 13-4: Three-Wire Format Signals*

A three-wire SPI network is shown in Figure 13-3. The master device selects the slave device using the slave select output. The communication starts with the master asserting the slave select line and then starting the clock (SCK). In three-wire SPI communication, the master and slave must know the data's intended direction to prevent bus contention. For a write, the master drives the data out of the SISO pin. The master must release the SISO line for a read and let the slave drive the SISO line. The direction of transmission is controlled using the FIFO. Writing to the FIFO starts the three-wire SPI write, and reading from the FIFO starts a three-wire SPI read transaction.

*Figure 13-3: Generic 3-Wire SPI Master to Slave Connection*

## Pin Configuration
Before configuring the SPI peripheral, first, disable any SPI activity for the port by clearing the SPIn_CTRL0.en field to 0.

### SPI Alternate Function Mapping
Pin selection and configuration are required to use the SPI port. The following information applies to SPI master and slave operations in three-wire, four-wire, dual, and quad mode communications. Determine the pins required for the SPI type and mode in the application, and configure the required GPIO as described in the following sections. Refer to the MAX78000 data sheet for pin availability for a specific package.

When the SPI port is disabled, SPIn_CTRL0.en = 0, the GPIO pins enabled for SPI alternate function are placed in high-impedance input mode.

### Four-Wire Format Configuration
Four-wire SPI uses SCK, MISO, MOSI, and one or more SS pins. Four-wire SPI may use more than one slave select pin for a transaction, resulting in more than four wires total; however, the communication is referred to as four-wire for legacy reasons.

*Note: Select the pins mapped to the SPI external device in the design and modify the setup accordingly. There is no restriction on which alternate function is used for a specific SPI pin, and each SPI pin can be used independently from the other pins chosen. However, it is recommended that only one set of GPIO port pins are used for any network.*

### Three-Wire Format Configuration
Three-wire SPI uses SCK, MOSI, and one or more slave select pins for an SPI transaction. Three-wire SPI configuration is identical to the four-wire configuration, except SPIn_MISO does not need to be set up for the SPI alternate function. The direction of communication in three-wire SPI mode is controlled by the SPI transmit and receive FIFO enables. Enabling the receive FIFO and disabling the transmit FIFO indicates a read transaction. Enabling the transmit FIFO and disabling the receive FIFO indicates a write transaction. It is an illegal condition to enable both the transmit and receive FIFOs in three-wire SPI operation.

### Dual-Mode Format Configuration
In dual-mode SPI, two I/O pins are used to transmit 2-bits of data per SCK clock cycle. The communication is half-duplex, and the direction of the data transmission must be known by both the master and slave for a given transaction. Dual-mode SPI uses SCK, SDIO0, SDIO1, and one or more slave select lines, as shown in Figure 13-4. The configuration of the GPIO pins for dual-mode SPI is identical to four-wire SPI. The mode is controlled by setting SPIn_CTRL2.data_width to 1, indicating that the SPI hardware uses SDIO0 and SDIO1 for half-duplex communication.

*Figure 13-4: Dual Mode SPI Connection Diagram*

### Quad-Mode Format Configuration
Quad-mode SPI uses four I/O pins to transmit four bits of data per transaction. In quad-mode SPI, the communication is half-duplex, and the master and slave must know the direction of transmission for each transaction. Quad-mode SPI uses SCK, SDIO0, SDIO1, SDIO2, SDIO3, and one or more slave select pins.

Quad-mode SPI transmits four bits per SCK cycle. The selection of quad mode SPI is selected by setting SPIn_CTRL2.data_width to 2.

## Clock Configuration
### Serial Clock
The SCK signal synchronizes data movement in and out of the device. The master drives SCK as an output to the slave's SCK pin. When SPI is set to master mode, the SPI bit rate generator creates the serial clock and outputs it on the configured SPIn_SCK pin. When SPI is configured for slave operation, the SPIn_SCK pin is an input from the external master, and the SPI hardware synchronizes communications using the SCK input. Operating as a slave, if an SPI slave select input is not asserted, the SPI ignores any signals on the serial clock and serial data lines.

In both master and slave devices, data is shifted on one edge of the SCK and is sampled on the opposite edge where data is stable. Data availability and sampling time are controlled using the SPI phase control field, SPIn_CTRL2.clkpha. The SCK clock polarity field, SPIn_CTRL2.clkpol, controls if the SCK signal is active high or active low.

The SPI peripheral supports four combinations of SCK phase and polarity referred to as SPI Modes 0, 1, 2, and 3. Clock Polarity (SPIn_CTRL2.clkpol) selects an active low/high clock and does not affect the transfer format. Clock phase (SPIn_CTRL2.clkpha) selects one of two different transfer formats.

The clock phase and polarity must be identical for the SPI master and slave for proper data transmission. The master always places data on the MOSI line a half-cycle before the SCK edge for the slave to latch the data. See Clock Phase and Polarity Control for additional details.

### Peripheral Clock
See Table 13-1 for the specific input clock, fINPUT_CLK, used for each SPI instance. For SPI instances assigned to the AHB bus, the SPI input clock is the system clock, SYS_CLK. For SPI instances mapped to the APB bus, the SPI input clock is the system peripheral clock, PCLK. The SPI input clock drives the SPI peripheral clock. The SPI provides an internal clock, SPIn_CLK, used within the SPI peripheral for the base clock to control the module and generate the SCK clock when in master mode. Set the SPI internal clock using the field SPIn_CLKCTRL.clkdiv as shown in Equation 13-1. Valid settings for SPIn_CLKCTRL.clkdiv are 0 to 8, allowing a divisor of 1 to 256.

*Equation 13-1: SPI Peripheral Clock*

### Master Mode Serial Clock Configuration
In master and multi-master mode, the SCK clock is generated by the master. The SPI provides control for both the high time and low time of the SCK clock. This control allows setting the high and low times for the SCK to duty cycles other than 50% if required. The SCK clock uses the SPI peripheral clock as a base value, and the high and low values are a count of the number of XXX clocks. Figure 13-5 visually represents the use of the SPIn_CLKCTRL.hi and SPIn_CLKCTRL.lo fields for a non-50% duty cycle serial clock generation. See Equation 13-2 and Equation 13-3 for calculating the SCK high and low time from the SPIn_CLKCTRL.hi and SPIn_CLKCTRL.lo field values.

*Figure 13-5: SCK Clock Rate Control*

*Equation 13-2: SCK High Time*

*Equation 13-3: SCK Low Time*

### Clock Phase and Polarity Control
SPI supports four combinations of clock and phase polarity as shown in Table 13-5. Clock polarity is controlled using the SPIn_CTRL2.clkpol bit and determines if the clock is active high or active low, as shown in Figure 13-6. Clock polarity does not affect the transfer format for SPI. The clock phase determines when the data must be stable for sampling. Setting the clock phase to 0, SPIn_CTRL2.clkpha = 0, dictates that the SPI data is sampled on the initial SPI clock edge regardless of clock polarity. Phase 1, SPIn_CTRL2.clkpha = 1, results in the data sample occurring on the second edge of the clock regardless of clock polarity.

*Figure 13-6: SPI Clock Polarity*

The clock phase and polarity must be identical for the SPI master and slave for proper data transmission. The master always places data on the MOSI line a half-cycle before the SCK edge for the slave to latch the data.

*Table 13-5: SPI Modes Clock Phase and Polarity Operation*

### Transmit and Receive FIFOs
The transmit FIFO hardware is 32 bytes deep. The write data width can be 8-, 16- or 32-bits wide. A 16-bit write queues a 16-bit word to the FIFO hardware. A 32-bit write queues two 16-bit words to the FIFO hardware with the least significant word dequeued first. Bytes must be written to two consecutive byte addresses, with the odd byte as the most significant byte and the even byte as the least significant byte. The FIFO logic waits for both the odd and even bytes to be written before dequeuing the 16-bit result to the FIFO.

The receive FIFO hardware is 32 bytes deep. Read data width can be 8-, 16- or 32-bits. A byte read from this register dequeues one byte from the FIFO. A 16-bit read from this register dequeues two bytes from the FIFO, the least significant byte first. A 32-bit read from this register dequeues four bytes from the FIFO, the least significant byte first.

### Interrupts and Wakeups
The SPI supports multiple interrupt sources. Status flags for each interrupt are set regardless of the state of the interrupt enable bit for that event. The event happens once when the condition is satisfied. The software must clear the status flag by writing a 1 to the interrupt flag.

The following FIFO interrupts are supported:

- Transmit FIFO empty
- Transmit FIFO threshold
- Receive FIFO full
- Receive FIFO threshold
- Transmit FIFO underrun

    - Slave mode only, master mode stalls the serial clock

- Transmit FIFO overrun
- Receive FIFO underrun
- Receive FIFO overrun

    - Slave mode only, master mode stalls the serial clock

- SPI supports interrupts for the internal state of the SPI and the external signals. The following transmission interrupts are supported:

    - SSn asserted or deasserted
    - SPI transaction complete
    - Master mode only
    - Slave mode transaction aborted
    - Multi-master fault

The SPI port can wake up the microcontroller from low-power modes when the wake event is enabled. SPI events that can wake the microcontroller are:

- Receive FIFO full
- Transmit FIFO empty
- Receive FIFO threshold
- Transmit FIFO threshold

## Registers
See Table 3-3 for the base address of this peripheral/module. If multiple instances of the peripheral are provided, each instance has its own independent set of the registers shown in Table 13-6. Register names for a specific instance are defined by replacing "n" with the instance number. As an example, a register PERIPHERALn_CTRL resolves to PERIPHERAL0_CTRL and PERIPHERAL1_CTRL for instances 0 and 1, respectively.

See Table 1-1 for an explanation of the read and write access of each field. Unless specified otherwise, all fields are reset on a system reset, soft reset, POR, and the peripheral-specific resets.

*Table 13-6: SPI Register Summary*

### Register Details

*Table 13-7: SPI 32-bit FIFO Register*